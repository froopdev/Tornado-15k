<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spotify Now Playing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(30, 215, 96, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .container {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 500px;
            padding: 20px;
        }

        .player-card {
            background: linear-gradient(145deg, rgba(30, 30, 46, 0.95) 0%, rgba(18, 18, 28, 0.95) 100%);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 80px rgba(30, 215, 96, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(30, 215, 96, 0.2);
            transition: all 0.3s ease;
        }

        .player-card.playing {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 100px rgba(30, 215, 96, 0.3);
            border-color: rgba(30, 215, 96, 0.4);
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .spotify-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            color: #1ed760;
            text-shadow: 0 0 20px rgba(30, 215, 96, 0.5);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #b3b3b3;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #535353;
            transition: all 0.3s ease;
        }

        .status-dot.playing {
            background: #1ed760;
            box-shadow: 0 0 10px rgba(30, 215, 96, 0.8);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }

        .album-art-container {
            position: relative;
            margin-bottom: 30px;
        }

        .album-art {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 16px;
            object-fit: cover;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease;
        }

        .album-art.playing {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .track-info {
            margin-bottom: 25px;
            text-align: center;
        }

        .track-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-artist {
            font-size: 18px;
            color: #b3b3b3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .progress-container {
            margin-bottom: 20px;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1ed760 0%, #1fdf64 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .progress-bar-wrapper:hover .progress-bar::after {
            opacity: 1;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #b3b3b3;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #fff;
            font-size: 20px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .control-btn.play-pause {
            width: 56px;
            height: 56px;
            background: #1ed760;
            font-size: 24px;
        }

        .control-btn.play-pause:hover {
            background: #1fdf64;
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(30, 215, 96, 0.5);
        }

        .login-container {
            text-align: center;
        }

        .login-btn {
            background: linear-gradient(135deg, #1ed760 0%, #1fdf64 100%);
            color: #fff;
            border: none;
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(30, 215, 96, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(30, 215, 96, 0.6);
        }

        .error-message {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 59, 48, 0.4);
            text-align: center;
        }

        .loading {
            text-align: center;
            color: #b3b3b3;
            font-size: 16px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid rgba(30, 215, 96, 0.2);
            border-top-color: #1ed760;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .last-played-badge {
            display: inline-block;
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 152, 0, 0.4);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .player-card {
                padding: 30px 25px;
            }

            .track-name {
                font-size: 24px;
            }

            .track-artist {
                font-size: 16px;
            }

            .spotify-logo {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .player-card {
                padding: 25px 20px;
            }

            .track-name {
                font-size: 20px;
            }

            .track-artist {
                font-size: 14px;
            }

            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .control-btn.play-pause {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="player-card" id="playerCard">
            <div id="loginView" class="login-container" style="display: none;">
                <div class="spotify-logo" style="justify-content: center; margin-bottom: 30px;">
                    <span>üéµ</span>
                    <span>Spotify Player</span>
                </div>
                <p style="color: #b3b3b3; margin-bottom: 30px;">Connect your Spotify account to see what you're listening to</p>
                <button class="login-btn" onclick="loginWithSpotify()">Connect Spotify</button>
            </div>

            <div id="playerView" style="display: none;">
                <div class="header">
                    <div class="spotify-logo">
                        <span>üéµ</span>
                        <span>Spotify</span>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">Idle</span>
                    </div>
                </div>

                <div id="lastPlayedBadge" style="text-align: center; display: none;">
                    <span class="last-played-badge">Last Played</span>
                </div>

                <div class="album-art-container">
                    <img class="album-art" id="albumArt" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Crect width='400' height='400' fill='%23282828'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='24' fill='%23b3b3b3' text-anchor='middle' dy='.3em'%3ENo Track%3C/text%3E%3C/svg%3E" alt="Album Art">
                </div>

                <div class="track-info">
                    <div class="track-name" id="trackName">Not Playing</div>
                    <div class="track-artist" id="trackArtist">Connect your Spotify account</div>
                </div>

                <div class="progress-container">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
                    </div>
                    <div class="time-info">
                        <span id="currentTime">0:00</span>
                        <span id="totalTime">0:00</span>
                    </div>
                </div>

                <div class="controls">
                    <button class="control-btn" title="Previous">‚èÆ</button>
                    <button class="control-btn play-pause" id="playPauseBtn" title="Play/Pause">‚è∏</button>
                    <button class="control-btn" title="Next">‚è≠</button>
                </div>
            </div>

            <div id="loadingView" class="loading">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>

            <div id="errorView" style="display: none;">
                <div class="error-message" id="errorMessage"></div>
                <div style="text-align: center;">
                    <button class="login-btn" onclick="loginWithSpotify()">Retry Login</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Spotify API Configuration
        // IMPORTANT: Replace 'YOUR_SPOTIFY_CLIENT_ID' with your actual Client ID from Spotify Developer Dashboard
        // Do NOT commit your real Client ID to public repositories
        const CLIENT_ID = 'YOUR_SPOTIFY_CLIENT_ID';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = 'user-read-currently-playing user-read-playback-state user-read-recently-played';
        const UPDATE_INTERVAL_MS = 5000; // Poll every 5 seconds (consider increasing if rate limited)
        
        let accessToken = null;
        let tokenExpiresAt = null;
        let updateInterval = null;

        // Initialize the app
        function init() {
            // Check for access token in URL (OAuth callback)
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            
            if (params.has('access_token')) {
                accessToken = params.get('access_token');
                const expiresIn = parseInt(params.get('expires_in'));
                tokenExpiresAt = Date.now() + (expiresIn * 1000);
                
                // Store token in session
                sessionStorage.setItem('spotify_token', accessToken);
                sessionStorage.setItem('token_expires_at', tokenExpiresAt);
                
                // Clean URL
                window.history.replaceState(null, null, window.location.pathname);
                
                showPlayerView();
                startUpdating();
            } else {
                // Check for stored token
                accessToken = sessionStorage.getItem('spotify_token');
                tokenExpiresAt = parseInt(sessionStorage.getItem('token_expires_at'));
                
                if (accessToken && tokenExpiresAt > Date.now()) {
                    showPlayerView();
                    startUpdating();
                } else {
                    showLoginView();
                }
            }
        }

        // Helper function to create fetch headers
        function createAuthHeaders() {
            return {
                'Authorization': `Bearer ${accessToken}`
            };
        }

        // Helper function to stop updates
        function stopUpdating() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        function showLoginView() {
            stopUpdating(); // Stop polling when showing login
            document.getElementById('loginView').style.display = 'block';
            document.getElementById('playerView').style.display = 'none';
            document.getElementById('loadingView').style.display = 'none';
            document.getElementById('errorView').style.display = 'none';
        }

        function showPlayerView() {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('playerView').style.display = 'block';
            document.getElementById('loadingView').style.display = 'none';
            document.getElementById('errorView').style.display = 'none';
        }

        function showLoadingView() {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('playerView').style.display = 'none';
            document.getElementById('loadingView').style.display = 'block';
            document.getElementById('errorView').style.display = 'none';
        }

        function showErrorView(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('playerView').style.display = 'none';
            document.getElementById('loadingView').style.display = 'none';
            document.getElementById('errorView').style.display = 'block';
        }

        function loginWithSpotify() {
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
            window.location.href = authUrl;
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        async function getCurrentlyPlaying() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                    headers: createAuthHeaders()
                });

                if (response.status === 204 || response.status === 202) {
                    // Nothing is playing, get recently played
                    return await getRecentlyPlayed();
                }

                if (response.status === 401) {
                    // Token expired
                    sessionStorage.removeItem('spotify_token');
                    sessionStorage.removeItem('token_expires_at');
                    stopUpdating(); // Stop polling on token expiration
                    showLoginView();
                    return null;
                }

                if (!response.ok) {
                    throw new Error('Failed to fetch currently playing track');
                }

                const data = await response.json();
                return {
                    ...data,
                    isPlaying: data.is_playing,
                    isRecentlyPlayed: false
                };
            } catch (error) {
                console.error('Error fetching currently playing:', error);
                return null;
            }
        }

        async function getRecentlyPlayed() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/recently-played?limit=1', {
                    headers: createAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch recently played tracks');
                }

                const data = await response.json();
                if (data.items && data.items.length > 0) {
                    const recentTrack = data.items[0];
                    return {
                        item: recentTrack.track,
                        progress_ms: 0,
                        isPlaying: false,
                        isRecentlyPlayed: true
                    };
                }
                return null;
            } catch (error) {
                console.error('Error fetching recently played:', error);
                return null;
            }
        }

        function updatePlayerUI(data) {
            if (!data || !data.item) {
                document.getElementById('trackName').textContent = 'No Track Playing';
                document.getElementById('trackArtist').textContent = 'Play something on Spotify';
                document.getElementById('statusText').textContent = 'Idle';
                document.getElementById('statusDot').classList.remove('playing');
                document.getElementById('playerCard').classList.remove('playing');
                document.getElementById('albumArt').classList.remove('playing');
                document.getElementById('lastPlayedBadge').style.display = 'none';
                return;
            }

            const track = data.item;
            const isPlaying = data.isPlaying;
            const isRecentlyPlayed = data.isRecentlyPlayed;

            // Update track info
            document.getElementById('trackName').textContent = track.name;
            document.getElementById('trackArtist').textContent = track.artists.map(a => a.name).join(', ');

            // Update album art (with safe optional chaining)
            const albumArt = track.album?.images?.[0]?.url || '';
            if (albumArt) {
                document.getElementById('albumArt').src = albumArt;
            }

            // Update status
            if (isRecentlyPlayed) {
                document.getElementById('statusText').textContent = 'Last Played';
                document.getElementById('statusDot').classList.remove('playing');
                document.getElementById('playerCard').classList.remove('playing');
                document.getElementById('albumArt').classList.remove('playing');
                document.getElementById('lastPlayedBadge').style.display = 'block';
                document.getElementById('playPauseBtn').textContent = '‚ñ∂';
            } else if (isPlaying) {
                document.getElementById('statusText').textContent = 'Playing';
                document.getElementById('statusDot').classList.add('playing');
                document.getElementById('playerCard').classList.add('playing');
                document.getElementById('albumArt').classList.add('playing');
                document.getElementById('lastPlayedBadge').style.display = 'none';
                document.getElementById('playPauseBtn').textContent = '‚è∏';
            } else {
                document.getElementById('statusText').textContent = 'Paused';
                document.getElementById('statusDot').classList.remove('playing');
                document.getElementById('playerCard').classList.remove('playing');
                document.getElementById('albumArt').classList.remove('playing');
                document.getElementById('lastPlayedBadge').style.display = 'none';
                document.getElementById('playPauseBtn').textContent = '‚ñ∂';
            }

            // Update progress (with safe division check)
            if (!isRecentlyPlayed) {
                const progress = data.progress_ms || 0;
                const duration = track.duration_ms || 0;
                const progressPercent = duration > 0 ? (progress / duration) * 100 : 0;

                document.getElementById('progressBar').style.width = `${progressPercent}%`;
                document.getElementById('currentTime').textContent = formatTime(progress);
                document.getElementById('totalTime').textContent = formatTime(duration);
            } else {
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('currentTime').textContent = '0:00';
                document.getElementById('totalTime').textContent = formatTime(track.duration_ms || 0);
            }
        }

        async function updateNowPlaying() {
            const data = await getCurrentlyPlaying();
            updatePlayerUI(data);
        }

        function startUpdating() {
            updateNowPlaying();
            // Update every UPDATE_INTERVAL_MS (5 seconds by default)
            stopUpdating(); // Clear any existing interval
            updateInterval = setInterval(updateNowPlaying, UPDATE_INTERVAL_MS);
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
